{'event': 'on_chat_model_start', 'data': {'input': {'messages': [[SystemMessage(content='# TODO MANAGEMENT\nBased upon the user\'s request:\n1. Use the write_todos tool to create TODO at the start of a user request, per the tool description.\n2. After you accomplish a TODO, use the read_todos to read the TODOs in order to remind yourself of the plan. \n3. Reflect on what you\'ve done and the TODO.\n4. Mark you task as completed, and proceed to the next TODO.\n5. Continue this process until you have completed all TODOs.\n\nIMPORTANT: Always create a research plan of TODOs and conduct research following the above guidelines for ANY user request.\n\n\nTools for reading and processing document files to extract and utilize their content effectively.\n\n**Available Tools:**\n1. read_text_file: Read text file content (automatically cached for reuse)\n2. read_excel_file: Read Excel file and return as CSV string\n3. create_pdf_file: Create PDF from text, upload to S3, return presigned download link\n4. read_pdf_file: Extract text from PDF (automatically cached for reuse)\n5. delete_file: Delete a file from the specified directory\n6. check_file_exists: Check if a file exists at the specified location\n7. list_cached_files: See all files cached in this conversation\n8. get_cached_file: Retrieve previously cached file content\n\n**CACHING BEHAVIOR:**\n- Files are automatically cached after first read (PDFs, text files, images)\n- Follow-up questions about same file use cached content (instant, no re-reading)\n- User can reference multiple files throughout conversation\n- Use list_cached_files to see what\'s available\n- Use get_cached_file to retrieve without re-reading from disk\n\n\nTools for analyzing images to extract meaningful information and insights.\n\n**Available Tool:**\n1. analyze_image: Analyze image and return description (results cached for reuse)\n\n**CACHING BEHAVIOR:**\n- Image analysis results are automatically cached\n- Same question about same image = instant cached response\n- Different questions trigger new analysis\n- Check cache with list_cached_files before re-analyzing\n\n**Usage:**\n- Always use check_file_exists first to verify image path\n- Results cached as: image_analysis_{filename}_{question}\n\n\nCRITICAL: You MUST use write_todos tool for ANY user request to create a plan before proceeding.\n================================================================================\n\n# SUB-AGENT DELEGATION\n\n Calendar_Agent\n**Use for**: Google Calendar operations\n- Creating/viewing/updating calendar events\n- **IMPORTANT**: ALWAYS include the user\'s EXACT email address in your instructions\n- Check authentication status first: "Check authentication status for [user_email]"\n- To revoke and re-authenticate: "Revoke access for [old_email] and generate auth URL for [new_email]"\n**Examples**: \n- "Check authentication status for mahdiharoun44@gmail.com"\n- "List events for tomorrow for mahdiharoun44@gmail.com"\n- "Revoke access for omar.yousef@example.com and generate auth URL for mahdiharoun44@gmail.com"\n\n Analysis_Agent\n**Use for**: Analysis operations\n- Plot generation and visualization\n- Statistical analysis and predictions\n- Data analysis jobs with timestamps\n- **IMPORTANT**: Always retrieve required data from DB_Tools first, then provide it to the analysis agent\n- Include both the task description and the data in your request\n\n Auth_Agent\n**Use for**: Authentication operations\n- **CRITICAL**: For restricted actions, ALWAYS send OTP code and verify token before proceeding\n- No exceptions - invalid/missing token = action denied\n**Restricted Actions Requiring Authentication:**\n- Database deletions\n- Database updates\n- Any delete operations\n- Any update operations\n- Create operations are NOT restricted\n\n\n### Email Validation Protocol\nBefore sending emails:\n1. If recipient email not provided → **ask for it**\n2. Validate email format (user@domain.com)\n3. If invalid format → reject and explain proper format\n\n### Calendar Authentication Protocol\nBefore calendar operations:\n1. Request email if not provided\n2. Check authentication: "Check authentication status for [email]"\n3. If not authenticated → guide through authentication process\n4. Only then proceed with calendar task\n\n### Analysis Data Protocol\nBefore analysis operations:\n1. Retrieve sufficient data using DB_Tools\n2. Confirm plot/analysis type with user\n3. Send both data AND instructions in natural language to Analysis_Agent_As_Tool\n4. Always include data payload with every analysis request\n\n### Authentication Security Protocol\nBefore DELETE/UPDATE operations:\n1. Use Auth_Agent_As_Tool to send OTP verification\n2. Wait for user to provide verification token\n3. Only proceed if token is verified\n4. Use static email stored in tool (don\'t ask user for email)\n\n\n### External Communication Agent \n1. if user asked after getting a plot response from the analysis to send it by email call AWS s3 agent to download the plot using the presigned url you got from the analysis agent and send it to the user email using the external communication agent \n2 . **IMPORTANT** after each download operation from aws s3 agent make sure to delete the local file after sending it by email to avoid storage overload\n3. you can check if the file exists before sending it by email using the check_file_exists tool from the main agent\n\n### RAG_Agent \n**Use for**: RAG system operations\n- Document retrieval and question answering using the vector database\n- Adding/updating/deleting documents in the RAG system\n\n**CRITICAL DOCUMENT MANAGEMENT RULES:**\n1. **NEVER process documents yourself** - You are NOT allowed to read, parse, or chunk documents\n2. **For file-based document operations:**\n   - DO NOT use read_pdf_file, read_text_file, or any document processing tools\n   - IMMEDIATELY delegate to RAG_Agent with ONLY the file path\n   - RAG_Agent will use add_document_from_file tool automatically\n3. **Delegation format:**\n   - "Add document from [FILE_PATH] to collection [COLLECTION_NAME]"\n   - Example: "Add document from /tmp/abc123/report.pdf to collection rag_db.test"\n4. **Your ONLY job:** Forward the file path and collection name - nothing else\n\n**Example Delegation:**\nUser: "Upload this PDF to rag collection rag_db.test" [file attached]\nFile Path: /tmp/thread_abc/document.pdf\nYour Action: Call RAG_Agent_As_Tool("Add document from /tmp/thread_abc/document.pdf to collection rag_db.test")\nDO NOT: Read, parse, open, or process the file in any way\n\n### You must always return the authnentication URL to the user if authentication is required.\n\nfor update or delete operations you must always use the Auth_Agent to verify the user before proceeding with the operation.\n\nif you giving a image path , use analyze_image tool from the image analysis tools to analyze the image and give a description about it.\n', additional_kwargs={}, response_metadata={}), HumanMessage(content='hi', additional_kwargs={}, response_metadata={}, id='7c66c918-1c4d-46b2-be75-91a056b0ba33'), AIMessage(content=[{'type': 'text', 'text': "Hello! I'm here to help you with various tasks including database operations, file analysis, calendar management, web searches, and much more. \n\nWhat would you like to do today? I can help you with things like:\n- Database queries and analysis\n- Reading and analyzing documents (PDFs, Excel files, text files)\n- Creating visualizations and reports\n- Managing calendar events\n- Sending emails\n- Web searches\n- And many other tasks\n\nJust let me know what you need assistance with!", 'index': 0}], additional_kwargs={}, response_metadata={'model_provider': 'bedrock', 'stop_reason': 'end_turn', 'stop_sequence': None, 'model_name': 'us.anthropic.claude-sonnet-4-20250514-v1:0'}, id='lc_run--7de593f2-1579-49a4-83d8-bd3d3f4328ff', usage_metadata={'input_tokens': 3541, 'output_tokens': 109, 'total_tokens': 3650, 'input_token_details': {'cache_creation': 0, 'cache_read': 0}}), HumanMessage(content='tell me what this image appers to you [Attached file at /tmp/string_102e1ec9f523e0d4e387e39cd7cd81bc_revenue_by_month_-_latest_3_months.png]', additional_kwargs={}, response_metadata={}, id='38ae846b-8084-4d73-a445-32614cf403f9'), AIMessage(content=[{'type': 'text', 'text': "I'll analyze the image for you. Let me first check if the file exists and then examine what it shows.", 'index': 0}, {'type': 'tool_use', 'id': 'toolu_bdrk_01LzfaYYuLqj8jw7tUjZULVc', 'name': 'write_todos', 'input': {}, 'index': 1, 'partial_json': '{"todos": [{"content":"Check if the image file exists at the specified path","status":"pending"},{"content":"Analyze the image to describe what it appears to show","status":"pending"}]}'}], additional_kwargs={}, response_metadata={'model_provider': 'bedrock', 'stop_reason': 'tool_use', 'stop_sequence': None, 'model_name': 'us.anthropic.claude-sonnet-4-20250514-v1:0'}, id='lc_run--757b1433-ecdd-4cdb-acc0-6c918c11953b', tool_calls=[{'name': 'write_todos', 'args': {'todos': [{'content': 'Check if the image file exists at the specified path', 'status': 'pending'}, {'content': 'Analyze the image to describe what it appears to show', 'status': 'pending'}]}, 'id': 'toolu_bdrk_01LzfaYYuLqj8jw7tUjZULVc', 'type': 'tool_call'}], usage_metadata={'input_tokens': 3709, 'output_tokens': 142, 'total_tokens': 3851, 'input_token_details': {'cache_creation': 0, 'cache_read': 0}}), ToolMessage(content="Updated todo list to [{'content': 'Check if the image file exists at the specified path', 'status': 'pending'}, {'content': 'Analyze the image to describe what it appears to show', 'status': 'pending'}]", name='write_todos', id='5cbbd876-f313-43ec-b9a2-b923d6d5f3a3', tool_call_id='toolu_bdrk_01LzfaYYuLqj8jw7tUjZULVc'), AIMessage(content=[{'type': 'tool_use', 'id': 'toolu_bdrk_013cnSJ4XyHeYZaQbjDWGibu', 'name': 'check_file_exists', 'input': {}, 'index': 0, 'partial_json': '{"file_location": "/tmp/string_102e1ec9f523e0d4e387e39cd7cd81bc_revenue_by_month_-_latest_3_months.png"}'}], additional_kwargs={}, response_metadata={'model_provider': 'bedrock', 'stop_reason': 'tool_use', 'stop_sequence': None, 'model_name': 'us.anthropic.claude-sonnet-4-20250514-v1:0'}, id='lc_run--1536ece9-d9bf-471e-8e77-3434f8afcf98', tool_calls=[{'name': 'check_file_exists', 'args': {'file_location': '/tmp/string_102e1ec9f523e0d4e387e39cd7cd81bc_revenue_by_month_-_latest_3_months.png'}, 'id': 'toolu_bdrk_013cnSJ4XyHeYZaQbjDWGibu', 'type': 'tool_call'}], usage_metadata={'input_tokens': 3899, 'output_tokens': 97, 'total_tokens': 3996, 'input_token_details': {'cache_creation': 0, 'cache_read': 0}}), ToolMessage(content='true', name='check_file_exists', id='0a98db04-cff4-43d7-84a8-1b99dfe751bb', tool_call_id='toolu_bdrk_013cnSJ4XyHeYZaQbjDWGibu')]]}}, 'name': 'ChatBedrock', 'tags': ['seq:step:1'], 'run_id': 'b4213aa7-6431-427c-8822-bb5a3af1015e', 'metadata': {'thread_id': 'string', 'langgraph_step': 12, 'langgraph_node': 'model', 'langgraph_triggers': ('branch:to:model',), 'langgraph_path': ('__pregel_pull', 'model'), 'langgraph_checkpoint_ns': 'model:22fa6653-1956-4135-2dee-cb4109d09704', 'checkpoint_ns': 'model:22fa6653-1956-4135-2dee-cb4109d09704', 'ls_provider': 'amazon_bedrock', 'ls_model_name': 'us.anthropic.claude-sonnet-4-20250514-v1:0', 'ls_model_type': 'chat', 'ls_temperature': 0.7}, 'parent_ids': ['0e175010-8f65-45ba-b9a8-ee0a48ed2cb1', '5311e3e4-a2b9-491b-b06e-9d9c7821ab52']}
